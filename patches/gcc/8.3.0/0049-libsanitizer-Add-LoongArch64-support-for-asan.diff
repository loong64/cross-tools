From dbf1f5e058bbe2a4abf69feab422ce4f466a4081 Mon Sep 17 00:00:00 2001
From: Yang Yujie <yangyujie@loongson.cn>
Date: Mon, 11 Dec 2023 17:47:04 +0800
Subject: [PATCH 08/15] libsanitizer: Add LoongArch64 support for asan.

Change-Id: Ia593843de4440df1dd6a6fc42ae68bb4b10c6371
---
 src/libsanitizer/asan/asan_mapping.h | 10 ++++++++++
 1 file changed, 10 insertions(+)

diff --git a/src/libsanitizer/asan/asan_mapping.h b/src/libsanitizer/asan/asan_mapping.h
index 5496df66d..888d42246 100644
--- a/src/libsanitizer/asan/asan_mapping.h
+++ b/src/libsanitizer/asan/asan_mapping.h
@@ -99,6 +99,13 @@
 // || `[0x10000000000000, 0x11ffffffffffff]` || LowShadow  ||
 // || `[0x00000000000000, 0x0fffffffffffff]` || LowMem     ||
 //
+// Default Linux/LoongArch64 (40-bit VMA) mapping:
+// || `[0x4000000000, 0xffffffffff]` || HighMem    ||
+// || `[0x2800000000, 0x3fffffffff]` || HighShadow ||
+// || `[0x2400000000, 0x27ffffffff]` || ShadowGap  ||
+// || `[0x2000000000, 0x23ffffffff]` || LowShadow  ||
+// || `[0x0000000000, 0x1fffffffff]` || LowMem     ||
+//
 // Shadow mapping on FreeBSD/x86-64 with SHADOW_OFFSET == 0x400000000000:
 // || `[0x500000000000, 0x7fffffffffff]` || HighMem    ||
 // || `[0x4a0000000000, 0x4fffffffffff]` || HighShadow ||
@@ -143,6 +150,7 @@ static const u64 kMIPS32_ShadowOffset32 = 0x0aaa0000;
 static const u64 kMIPS64_ShadowOffset64 = 1ULL << 37;
 static const u64 kPPC64_ShadowOffset64 = 1ULL << 41;
 static const u64 kSystemZ_ShadowOffset64 = 1ULL << 52;
+static const u64 kLoongArch64_ShadowOffset64 = 1ULL << 37;
 static const u64 kFreeBSD_ShadowOffset32 = 1ULL << 30;  // 0x40000000
 static const u64 kFreeBSD_ShadowOffset64 = 1ULL << 46;  // 0x400000000000
 static const u64 kNetBSD_ShadowOffset64 = 1ULL << 46;  // 0x400000000000
@@ -191,6 +199,8 @@ static const u64 kWindowsShadowOffset32 = 3ULL << 28;  // 0x30000000
 #   define SHADOW_OFFSET kDefaultShadowOffset64
 #  elif defined(__mips64)
 #   define SHADOW_OFFSET kMIPS64_ShadowOffset64
+#  elif SANITIZER_LOONGARCH64
+#   define SHADOW_OFFSET kLoongArch64_ShadowOffset64
 #  elif SANITIZER_WINDOWS64
 #   define SHADOW_OFFSET __asan_shadow_memory_dynamic_address
 #  else
-- 
2.39.3

