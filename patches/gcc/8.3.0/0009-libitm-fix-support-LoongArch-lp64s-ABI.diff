From 5c072e3cab3f3746ff96f5c3215000ab7aba912a Mon Sep 17 00:00:00 2001
From: Yang Yujie <yangyujie@loongson.cn>
Date: Fri, 30 Sep 2022 11:14:16 +0800
Subject: [PATCH 07/28] libitm fix: support LoongArch lp64s ABI.

Change-Id: I249ac4f3ef9488b72edb75b71868ec2017da9b9e
---
 src/libitm/config/loongarch/sjlj.S | 3 +++
 1 file changed, 3 insertions(+)

diff --git a/src/libitm/config/loongarch/sjlj.S b/src/libitm/config/loongarch/sjlj.S
index 3ffdd50cf..e8610f9b5 100644
--- a/src/libitm/config/loongarch/sjlj.S
+++ b/src/libitm/config/loongarch/sjlj.S
@@ -104,6 +104,8 @@ GTM_longjmp:
         GPR_L  $s7, $r5, 10*SZ_GPR
         GPR_L  $s8, $r5, 11*SZ_GPR
 
+#if !defined(__loongarch_soft_float)
+        /* Callee-saved scratch FPRs (f24-f31) */
         FPR_L  $f24, $r5, 12*SZ_GPR + 0*SZ_FPR
         FPR_L  $f25, $r5, 12*SZ_GPR + 1*SZ_FPR
         FPR_L  $f26, $r5, 12*SZ_GPR + 2*SZ_FPR
@@ -112,6 +114,7 @@ GTM_longjmp:
         FPR_L  $f29, $r5, 12*SZ_GPR + 5*SZ_FPR
         FPR_L  $f30, $r5, 12*SZ_GPR + 6*SZ_FPR
         FPR_L  $f31, $r5, 12*SZ_GPR + 7*SZ_FPR
+#endif
 
         GPR_L  $r7, $r5, 2*SZ_GPR
         GPR_L  $fp, $r5, 0*SZ_GPR
-- 
2.31.1

