From cacbfe1970a2f53fe742669305e5616b8be24d35 Mon Sep 17 00:00:00 2001
From: Yang Yujie <yangyujie@loongson.cn>
Date: Mon, 22 Jul 2024 09:25:38 +0800
Subject: [PATCH 1/3] LoongArch: Remove bash syntax ';&' from config.gcc.

Change-Id: I87d16edd42bccd615b811214eb5860a0263f003b
---
 src/gcc/config.gcc | 44 ++++++++++++++++++++++++--------------------
 1 file changed, 24 insertions(+), 20 deletions(-)

diff --git a/src/gcc/config.gcc b/src/gcc/config.gcc
index f2a65f1dd..1fdb43137 100644
--- a/src/gcc/config.gcc
+++ b/src/gcc/config.gcc
@@ -4706,22 +4706,24 @@ case "${target}" in
 					# multilib library builds, unless otherwise specified
 					# in --with-multilib-list.
 					with_multilib_default="/march=abi-default"
-					parse_state=opts
 					;;
 				arch,fixed)
 					# Fixed: use the default gcc configuration for all multilib
 					# builds by default.
 					with_multilib_default=""
-					parse_state=opts
 					;;
 				arch,*)
 					with_multilib_default="/march=abi-default"
-					parse_state=opts
-					;&
+					with_multilib_default="${with_multilib_default}/${component}"
+					;;
 				opts,*)
 					with_multilib_default="${with_multilib_default}/${component}"
 					;;
 				esac
+
+                                if test x${parse_state} = xarch; then
+                                    parse_state=opts;
+                                fi
 			done
 			unset parse_state component
 		fi
@@ -4759,8 +4761,7 @@ case "${target}" in
 			parse_state="abi-base"
 
 			for component in $(echo "${elem}" | tr '/' ' '); do
-				case ${parse_state} in
-				abi-base)
+				if test x${parse_state} = x"abi-base"; then
 					# Base ABI type
 					case ${component} in
 					lp64 | lp64d) elem_tmp="ABI_BASE_LP64D,";;
@@ -4776,9 +4777,10 @@ case "${target}" in
 					elem_abi_base="${component}"
 
 					parse_state="abi-ext"
-					;;
+					continue
+				fi
 
-				abi-ext)
+				if test x${parse_state} = x"abi-ext"; then
 					# ABI extension type
 					case ${component} in
 					base)
@@ -4786,7 +4788,7 @@ case "${target}" in
 						loongarch_multilib_list_c="${loongarch_multilib_list_c}ABI_EXT_BASE,"
 						loongarch_multilib_list_make="${loongarch_multilib_list_make}" # Add nothing for now.
 						parse_state="arch"
-						continue;
+						continue
 						;;
 					esac
 
@@ -4795,15 +4797,17 @@ case "${target}" in
 					loongarch_multilib_list_c="${loongarch_multilib_list_c}ABI_EXT_BASE,"
 					loongarch_multilib_list_make="${loongarch_multilib_list_make}" # Add nothing for now.
 					parse_state="arch"
-					;&
+				fi
 
-				arch)
+				if test x${parse_state} = x"arch"; then
 					# -march option
 					case ${component} in
 					abi-default | loongarch64 | la[2346]64) # OK, append here.
 						# Append -march spec for each multilib variant.
 						loongarch_multilib_list_make="${loongarch_multilib_list_make}/march=${component}"
-						;&
+						parse_state="opts"
+						continue
+						;;
 
 					default)
 						# "/default" is equivalent to --with-multilib-default=fixed
@@ -4815,9 +4819,9 @@ case "${target}" in
 					# If ARCH is unspecified for this multilib variant, use ${with_multllib_default}.
 					loongarch_multilib_list_make="${loongarch_multilib_list_make}${with_multilib_default}"
 					parse_state="opts"
-					;&
+				fi
 
-				opts)
+				if test x${parse_state} = x"opts"; then
 					# Other compiler options for building libraries.
 					# (no static sanity check performed)
 					case ${component} in
@@ -4828,22 +4832,22 @@ case "${target}" in
 						loongarch_multilib_list_make="${loongarch_multilib_list_make}/${component}"
 						;;
 					esac
-					;;
-
-				esac
+				fi
 			done
 
 			case ${parse_state} in
 			    "abi-ext")
 					elem_abi_ext="base"
 					loongarch_multilib_list_c="${loongarch_multilib_list_c}ABI_EXT_BASE,"
-					loongarch_multilib_list_make="${loongarch_multilib_list_make}" # Add nothing for now.
-					;&
+					# If ARCH is unspecified for this multilib variant, use ${with_multllib_default}.
+					loongarch_multilib_list_make="${loongarch_multilib_list_make}${with_multilib_default}"
+					;;
 			    "arch")
 					# If ARCH is unspecified for this multilib variant, use ${with_multllib_default}.
 					loongarch_multilib_list_make="${loongarch_multilib_list_make}${with_multilib_default}"
-					;&
+					;;
 			    "opts")
+					:
 					;;
 			esac
 
-- 
2.39.3

