From 22216a86fb29a2ee8ef2bd39f1574b9b4cb424da Mon Sep 17 00:00:00 2001
From: Yang Yujie <yangyujie@loongson.cn>
Date: Wed, 13 Dec 2023 11:35:16 +0800
Subject: [PATCH 05/15] LoongArch: enable __builtin_thread_pointer

Change-Id: I93e99be82832f44c6a422a9accf8a8ccf776448f
---
 src/gcc/config/loongarch/loongarch.md | 7 +++++++
 1 file changed, 7 insertions(+)

diff --git a/src/gcc/config/loongarch/loongarch.md b/src/gcc/config/loongarch/loongarch.md
index 4e02660d3..ca30c947d 100644
--- a/src/gcc/config/loongarch/loongarch.md
+++ b/src/gcc/config/loongarch/loongarch.md
@@ -106,6 +106,7 @@
 
 (define_constants
   [(RETURN_ADDR_REGNUM		1)
+   (TP_REGNUM                   2)
    (T0_REGNUM			12)
    (T1_REGNUM			13)
    (S0_REGNUM			23)
@@ -3606,6 +3607,12 @@
   [(set_attr "length" "0")
    (set_attr "type" "ghost")])
 
+;; Named pattern for __builtin_thread_pointer.
+(define_expand "get_thread_pointer<mode>"
+  [(set (match_operand:P 0 "register_operand" "=r")
+        (reg:P TP_REGNUM))]
+  ""
+  {})
 
 (define_split
   [(match_operand 0 "small_data_pattern")]
-- 
2.39.3

