From 523ae11d054e59e3c24ae3b0dde09dba9101d274 Mon Sep 17 00:00:00 2001
From: Yang Yujie <yangyujie@loongson.cn>
Date: Wed, 13 Dec 2023 09:18:17 +0800
Subject: [PATCH 09/15] libsanitizer: Enable LoongArch64.

Change-Id: Ib1758c8bbab8ecf3bb65c24197f4b415f4da8a2a
---
 src/gcc/config/loongarch/loongarch.c | 11 +++++++++++
 src/libsanitizer/configure.tgt       |  4 ++++
 2 files changed, 15 insertions(+)

diff --git a/src/gcc/config/loongarch/loongarch.c b/src/gcc/config/loongarch/loongarch.c
index 3041e819c..1658b4939 100644
--- a/src/gcc/config/loongarch/loongarch.c
+++ b/src/gcc/config/loongarch/loongarch.c
@@ -4231,6 +4231,14 @@ loongarch_constant_alignment (const_tree exp, HOST_WIDE_INT align)
   return align;
 }
 
+/* Implement TARGET_ASAN_SHADOW_OFFSET hook.  */
+
+static unsigned HOST_WIDE_INT
+loongarch_asan_shadow_offset (void)
+{
+  return 1ULL << 37;
+}
+
 const char *
 loongarch_output_move_index (rtx x, machine_mode mode, bool ldr)
 {
@@ -11044,6 +11052,9 @@ loongarch_prefetch_cookie (rtx write, rtx locality)
 #undef TARGET_CONSTANT_ALIGNMENT
 #define TARGET_CONSTANT_ALIGNMENT loongarch_constant_alignment
 
+#undef TARGET_ASAN_SHADOW_OFFSET
+#define TARGET_ASAN_SHADOW_OFFSET loongarch_asan_shadow_offset
+
 #undef TARGET_STARTING_FRAME_OFFSET
 #define TARGET_STARTING_FRAME_OFFSET loongarch_starting_frame_offset
 
diff --git a/src/libsanitizer/configure.tgt b/src/libsanitizer/configure.tgt
index 573e3b482..cd8cd40f3 100644
--- a/src/libsanitizer/configure.tgt
+++ b/src/libsanitizer/configure.tgt
@@ -55,6 +55,10 @@ case "${target}" in
   x86_64-*-darwin[1]* | i?86-*-darwin[1]*)
 	TSAN_SUPPORTED=no
 	;;
+  loongarch64-*-linux*)
+        TSAN_SUPPORTED=no
+        LSAN_SUPPORTED=yes
+        ;;
   *)
 	UNSUPPORTED=1
 	;;
-- 
2.39.3

